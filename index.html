<!DOCTYPE html>
<html lang="en">

<head>
    <title>Pupillometry</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TYZKVQ1R7B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-TYZKVQ1R7B');

    </script>
    <!-- Import the webpage's stylesheet -->
    <link rel="stylesheet" href="css/main.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
    <section id="input-params">
        <header>
            <img id="logo" alt="MEye Pupillometry Logo" src="img/logo_transparent.png">
        </header>
        <fieldset id="capture-params">
            <legend>Input (Camera)</legend>
            <input type="button" id="webcamButton" value="Enable Webcam">
        </fieldset>
        <fieldset id="video-file-params">
            <legend>Input (File)</legend>
            <label for="file-input"></label><input type="file" accept="video/*" id="file-input">
            <span id="input-error"></span>
        </fieldset>
        <fieldset id="model-params">
            <legend>Model</legend>
            <select id="model-selector">
                <option value="meye-segmentation_i128_s4_c1_f16_g1_a-relu-no-subj">mini-UNet (0.1 MB)</option>
                <option value="deeplab_lite-mobilenetv3-small">DeepLabv3+/Lite-MobileNet-V3-Small (4.0 MB)</option>
            </select>
        </fieldset>
        <fieldset id="demo-params">
            <legend>Demos</legend>
            <input type="button" value="Human" class="demo-button" data-src="demo/h_f.mp4" data-rx="140" data-ry="60" data-rs="342" data-rt="1" data-period="0" data-thr="0.25" data-morph="0">
            <input type="button" value="Mouse" class="demo-button" data-src="demo/hf_mouse.mp4" data-rx="80" data-ry="80" data-rs="90" data-rt="0" data-period="0" data-thr="0.15" data-morph="1">
            <input type="button" value="2P Mouse" class="demo-button" data-src="demo/2p_mouse.mp4" data-rx="100" data-ry="100" data-rs="90" data-rt="0" data-period="0" data-thr="0.5" data-morph="1">
        </fieldset>
    </section>

    <section id="processing">
        <aside class="pre-post-params">
            <fieldset id="roi-preview">
                <legend>INPUT PREVIEW</legend>
                <canvas id="net-input" width="128" height="128"></canvas>
            </fieldset>

            <fieldset id="roi-params">
                <legend>ROI</legend>
                <div id="roi-coords">
                    <label for="roi-left" title="X-coordinate of top left corner of the ROI">X:<input type="number" min="0" id="roi-left"></label>
                    <label for="roi-top" title="Y-coordinate of top left corner of the ROI">Y:<input type="number" min="0" id="roi-top"></label>
                </div>
                <label for="roi-size" title="Length of the side of the squared ROI">Size:<input type="number" min="0" id="roi-size"></label>
                <label for="roi-track" title="Whether to move the ROI to track the pupil center">Track Pupil:<input type="checkbox" id="roi-track" checked></label>
            </fieldset>

            <fieldset id="preproc-params">
                <legend>Preprocess</legend>
                <label for="control-contrast-preview" title="Adjust image contrast">Contrast: <input type="number" min="0" max="2" step="0.01" value="1.00" id="control-contrast-preview"></label>
                <label><input type="range" min="0" max="100" id="control-contrast"></label>
                <label for="control-brightness-preview" title="Adjust image brightness">Brightness: <input type="number" min="-1" max="1" step="0.01" value="0.00" id="control-brightness-preview"></label>
                <label><input type="range" min="0" max="100" id="control-brightness"></label>
                <label for="control-gamma-preview" title="Adjust image Gamma">Gamma: <input type="number" min="0" max="2" step="0.01" value="1.00" id="control-gamma-preview"></label>
                <label><input type="range" min="0" max="100" id="control-gamma"></label>
                <label for="control-invert" title="Invert image">Invert: <input type="checkbox" id="control-invert"></label>
                <input type="reset" value="Reset" id="control-preproc-reset">
            </fieldset>
        </aside>

        <fieldset id="video-params">
            <legend>
                <div class="flex-legend">
                    Output
                    <label><meter id="fps-meter" min=0 low=8 optimum=24 max=30></meter> FPS: <span id="fps-preview"></span></label>
                    <label id="backend-preview">(Backend: <span id="backend-text"></span>)</label>
                </div>
            </legend>
            <div id="preview">
                <div id="roi">
                    <div draggable="true" id="roi-dragger"></div>
                    <div draggable="true" id="roi-resizer"></div>
                    <canvas id="output"></canvas>
                </div>
                <div id="pupil-x"><span>x=13.0</span></div>
                <div id="pupil-y"><span>y=24.1</span></div>
                <video id="webcam" controls="1"></video>
            </div>
        </fieldset>

        <aside class="pre-post-params">
            <fieldset id="filter-params">
                <legend>Prediction</legend>
                <label for="control-period" title="Time to wait between predictions (0 = fastest possible)">Period (ms): <input type="number" min="0" value=0 id="control-period"></label>
                <label for="control-thr-preview" title="Pupil probability map threshold">Threshold: <input type="number" min="0" max="1" step="0.01" value="0.50" id="control-thr-preview"></label>
                <label><input type="range" min="0" max="100" id="control-thr"></label>
                <label for="control-morphology" title="Morphological post-processing (non-largest component suppression, hole filling)">Morphology: <input type="checkbox" id="control-morphology" checked></label>
            </fieldset>

            <fieldset id="triggers-params">
                <legend>Triggers</legend>
                <input type="button" value="Trigger 1 (Q)" class="control-trigger" accesskey="q" data-trigger-id="0">
                <input type="button" value="Trigger 2 (W)" class="control-trigger" accesskey="w" data-trigger-id="1">
                <input type="button" value="Trigger 3 (E)" class="control-trigger" accesskey="e" data-trigger-id="2">
                <input type="button" value="Trigger 4 (R)" class="control-trigger" accesskey="r" data-trigger-id="3">
            </fieldset>

            <fieldset id="option-params">
                <legend>Options</legend>
                <label for="control-clear-on-resume">Clear on Resume: <input type="checkbox" id="control-clear-on-resume" checked></label>
            </fieldset>

            <fieldset id="links">
                <legend>Links</legend>
                <ul>
                    <li><a target="_blank" href="https://github.com/fabiocarrara/meye/wiki"><img src="img/baseline_menu_book_black_36dp.png">Manual</a></li>
                    <li><a target="_blank" href="https://github.com/fabiocarrara/meye/blob/master/LICENSE"><img src="img/baseline_history_edu_black_36dp.png">License GPLv3</a></li>
                    <li><a target="_blank" href="https://github.com/fabiocarrara/meye/"><img src="img/baseline_code_black_36dp.png">GitHub Project</a></li>
                    <li><a target="_blank" href="https://github.com/fabiocarrara/meye/issues/new/choose"><img src="img/baseline_bug_report_black_36dp.png">Report Bugs</a></li>
                    <li><a target="_blank" href="https://www.freeconvert.com/avi-to-mp4"><img src="img/baseline_video_settings_black_36dp.png">AVI Converter</a></li>
                </ul>
            </fieldset>
        </aside>
    </section>

    <section id="outputs">
        <fieldset id="out-graph" class="out">
            <legend>
                <!-- thanks FF.. -->
                <div class="flex-legend">
                    Plot
                    <span>
                        <label><input type="checkbox" id="control-plot-autoupdate" checked> Auto-Update</label>
                        <label><input type="checkbox" id="control-plot-window-enable" checked> Show only <input type="number" min="1" value=100 id="control-plot-window"> last samples</label>
                        <label><input type="checkbox" id="control-plot-smooth"> Smooth Lines</label>
                        <label><input type="button" id="control-plot-update" value="Update Plot"></label>
                    </span>
                </div>
            </legend>
            <div id="chart-container"></div>
        </fieldset>

        <fieldset id="out-data" class="out">
            <legend>
                <div class="flex-legend">
                    Data
                    <output id="sample-count">0</output>
                    <span>
                        <label><input type="checkbox" id="control-table-autoupdate" checked> Auto-Update</label>
                        <input type="button" value="Update Table" id="control-table-update">
                        <input type="button" value="Clear Data" id="control-clear" accesskey="c">
                        <input type="button" value="Export CSV" id="control-export-csv" accesskey="e">
                    </span>
                </div>
            </legend>
            <div id="sticky-header">
                <table id="trace">
                    <thead>
                        <th>timestamp</th>
                        <th>timecode</th>
                        <th>pupil-area</th>
                        <th>blink</th>
                        <th>px</th>
                        <th>py</th>
                        <th>t1</th>
                        <th>t2</th>
                        <th>t3</th>
                        <th>t4</th>
                    </thead>
                    <tbody id="trace-data"></tbody>
                </table>
            </div>
        </fieldset>
    </section>
    <footer>
        <p>
            <span>
                Credits:
            <b>Raffaele Mazziotti</b><sup>1,2</sup>,
            <b>Fabio Carrara</b><sup>3</sup>,
            <b>Giuseppe Amato</b><sup>3</sup>, and
            <b>Tommaso Pizzorusso</b><sup>1,2,4</sup>
            </span>
            &mdash;
            <span><sup>1</sup><a href="https://www.neurofarba.unifi.it/">NEUROFARBA UniFi</a></span> &diams;
            <span><sup>2</sup><a href="http://www.in.cnr.it/index.php/it/">IN CNR</a></span> &diams;
            <span><sup>3</sup><a href="https://www.isti.cnr.it/">ISTI CNR</a></span> &diams;
            <span><sup>4</sup><a href="https://www.sns.it/en/laboratorio-di-biologia">BIO@SNS</a></span>
        </p>
    </footer>
    <div id="loading"><span>Loading model...</span></div>
    <!-- Import TensorFlow.js library -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js" type="text/javascript"></script>
    <!-- Import the page's JavaScript to do some stuff -->
    <script src="js/main.js" defer></script>
</body>

</html>
